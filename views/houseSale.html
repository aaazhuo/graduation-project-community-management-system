<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>房屋出售</title>
	<meta name="renderer" content="webkit">	
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">	
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">	
	<meta name="apple-mobile-web-app-status-bar-style" content="black">	
	<meta name="apple-mobile-web-app-capable" content="yes">	
	<meta name="format-detection" content="telephone=no">	
	<link rel="stylesheet" type="text/css" href="/common/layui/css/layui.css" media="all">
	<link rel="stylesheet" type="text/css" href="/common/bootstrap/css/bootstrap.css" media="all">
	<link rel="stylesheet" type="text/css" href="/common/global.css" media="all">
	<link rel="stylesheet" type="text/css" href="/css/personal.css" media="all">
</head>
<body>
<section class="layui-larry-box">
	<div class="larry-personal">
	    <div class="layui-tab layui-form">
            <blockquote class="layui-elem-quote news_search">
		        <div class="layui-inline">
					<div class="layui-input-inline">
                        <select name="houseSale_filter" lay-filter="houseSale_filter" lay-verify="required">
                            <option value="">请选择出租/出售</option>
                            <option value="0">房屋出租</option>
                            <option value="1">房屋出售</option>
                        </select>
                    </div>
                    <div class="layui-input-inline" id="structure_select">  
                        <input name="structure" placeholder="请输入房屋户型" class="layui-input search_input" type="text">
                    </div>
                    <div class="layui-inline" id="area_select">
                        <div class="layui-inline">
                            <div class="layui-input-inline" style="width: 150px;">
                                <input type="text" name="area_min" placeholder="请输入最小面积" autocomplete="off" class="layui-input">
                            </div>
                            --
                            <div class="layui-input-inline" style="width: 150px;">
                                <input type="text" name="area_max" placeholder="请输入最大面积" autocomplete="off" class="layui-input">
                            </div>
                        </div>  
                    </div>
                    <div class="layui-inline" id="price_select">
                        <div class="layui-inline">
                            <div class="layui-input-inline" style="width: 150px;">
                                <input type="text" name="price_min" placeholder="￥请输入最小价格" autocomplete="off" class="layui-input">
                            </div>
                            --
                            <div class="layui-input-inline" style="width: 150px;">
                                <input type="text" name="price_max" placeholder="￥请输入最大价格" autocomplete="off" class="layui-input">
                            </div>
                        </div>  
                    </div>
		            <button class="layui-btn" lay-submit lay-filter="search"><i class="layui-icon">&#xe615;</i>查询</button>
                </div>
	        </blockquote>
            
            <!-- 房屋出售信息 -->
			<table id="houseSale" lay-filter="houseSale"></table>
		</div>
	</div>
</section>
<div id="examine" style="display:none">
	<div class="layui-carousel" id="houseImg">
		<div carousel-item="">
			<div><img src="/uploadImage/1.jpg"></div>
			<div><img src="/uploadImage/2.jpg"></div>
			<div><img src="/uploadImage/3.jpg"></div>
			<div><img src="/uploadImage/4.jpg"></div>
			<div><img src="/uploadImage/5.jpg"></div>
		</div>
	</div>
	<form class="layui-form" style="padding:20px;" id="houseSaleMsg">
		<input type="hidden" name="_id" autocomplete="off" class="layui-input">
		<div class="layui-form-item">
			<label class="layui-form-label">房屋住址</label>
			<div class="layui-input-inline">
				<input type="text" name="address" autocomplete="off" class="layui-input layui-disabled" disabled="disabled">
			</div>
			<div class="layui-form-mid layui-word-aux">房屋住址：例7-107：7栋107房</div>
		</div>
		<div class="layui-form-item">
			<label class="layui-form-label">房屋结构</label>
			<div class="layui-input-inline">
				<input type="text" name="structure" autocomplete="off" class="layui-input layui-disabled" disabled="disabled">
			</div>
		</div>
		<div class="layui-form-item">
			<label class="layui-form-label">房屋面积</label>
			<div class="layui-input-inline">
			    <input type="text" name="area" autocomplete="off" class="layui-input layui-disabled" disabled="disabled">
			</div>
			<div class="layui-form-mid layui-word-aux">面积单位：㎡</div>
		</div>
		<div class="layui-form-item">
			<label class="layui-form-label">房屋状态</label>
			<div class="layui-input-inline">
				<input type="text" name="status" autocomplete="off" class="layui-input layui-disabled" disabled="disabled">
			</div>
		</div>
		<div class="layui-form-item">
			<label class="layui-form-label">房屋出租价格</label>
			<div class="layui-input-inline">
				<input type="text" name="rentalPrice" autocomplete="off" class="layui-input layui-disabled" disabled="disabled">
			</div>
		</div>
		<div class="layui-form-item">
			<label class="layui-form-label">房屋出售价格</label>
			<div class="layui-input-inline">
				<input type="text" name="salePrice" autocomplete="off" class="layui-input layui-disabled" disabled="disabled">
			</div>
		</div>
		<div class="layui-form-item layui-form-text">
			<label class="layui-form-label">备注</label>
			<div class="layui-input-block">
				<textarea name="desc" placeholder="请输入备注" class="layui-textarea layui-disabled" disabled="disabled"></textarea>
			</div>
        </div>
        <div class="layui-form-item">
            <div class="layui-input-block">
                <button class="layui-btn" lay-submit lay-filter="confirmRental" id="confirmRental">确定出租</button>
                <button class="layui-btn" lay-submit lay-filter="confirmSale" id="confirmSale">确定出售</button>
            </div>
        </div>
	</form>
</div>
<script type="text/html" id="barDemo">
	<a class="layui-btn layui-btn-xs" lay-event="detail">查看房屋详情</a>
</script>
<script type="text/javascript" src="/common/layui/layui.js"></script>
<script type="text/javascript" src="/js/com.js"></script>
<script type="text/javascript">
	layui.config({
        base:'js/'
    }).use(['jquery','layer','element','table','form','carousel','requestData'],function(){   
		var element = layui.element,
			  layer = layui.layer,
			laypage = layui.laypage,
                  $ = layui.jquery,
               form = layui.form,
			  table = layui.table,
		   carousel = layui.carousel,
		requestData = layui.requestData;

		//判断出租/出售状态 0：出租；1出售 2：未选择
		var flag = 2;

        //渲染数据表格
		var HouseSaleTable = table.render({
			elem: '#houseSale',
			response:{
				statusName: 'errcode', //数据状态的字段名称，默认：code
				statusCode: 0, //成功的状态码，默认：0
				countName: 'total', //数据总数的字段名称，默认：count
				dataName: 'data' //数据列表的字段名称，默认：data
			},
			height: 660,
			page:true,
			limit:12,
			limits:[12,20,30],
			url: '/ajax/getHouseInfo', //数据接口
			where:{
				status:'空闲'
			},
			cols: [[ //表头
				{title: '序号',type: 'numbers',width:100},
				{field: 'structure', title: '房屋结构', width:150},
				{field: 'area', title: '房屋面积', width:150,sort: true},
				{field: 'rentalPrice', title: '出租价格', width: 150, sort: true},
				{field: 'salePrice', title: '出售价格', width: 150, sort: true},
				{field: 'status', title: '房屋状态', width: 100},
				{field: 'address', title: '房屋住址'},
				{fixed: 'right', width:250, align:'center', toolbar: '#barDemo'} //这里的toolbar值是模板元素的选择器
			]]
        });

        form.on('submit(search)',function(data){
			if (data.field.houseSale_filter === '0'){
				flag = 0;
				// 出租查询
				HouseSaleTable.reload({
				where:{
					status:'空闲',
					type:0,
					structure: data.field.structure,
					area_min: data.field.area_min,
					area_max: data.field.area_max,
					price_min:data.field.price_min,
					price_max:data.field.price_max
				},
				page: {
					curr: 1 //重新从第 1 页开始
				},
				cols: [[ //表头
					{title: '序号',type: 'numbers',width:100},
					{field: 'structure', title: '房屋结构', width:150},
					{field: 'area', title: '房屋面积', width:150,sort: true},
					{field: 'rentalPrice', title: '出租价格', width: 150, sort: true},
					{field: 'status', title: '房屋状态', width: 100},
					{field: 'address', title: '房屋住址'},
					{fixed: 'right', width:250, align:'center', toolbar: '#barDemo'} //这里的toolbar值是模板元素的选择器
				]]
			})
			} else if(data.field.houseSale_filter === '1'){
				flag = 1;
				// 出售查询
				HouseSaleTable.reload({
				where:{
					status:'空闲',
					type:1,
					structure: data.field.structure,
					area_min: data.field.area_min,
					area_max: data.field.area_max,
					price_min:data.field.price_min,
					price_max:data.field.price_max
				},
				page: {
					curr: 1 //重新从第 1 页开始
				},
				cols: [[ //表头
					{title: '序号',type: 'numbers',width:100},
					{field: 'structure', title: '房屋结构', width:150},
					{field: 'area', title: '房屋面积', width:150,sort: true},
					{field: 'salePrice', title: '出售价格', width: 150, sort: true},
					{field: 'status', title: '房屋状态', width: 100},
					{field: 'address', title: '房屋住址'},
					{fixed: 'right', width:250, align:'center', toolbar: '#barDemo'} //这里的toolbar值是模板元素的选择器
				]]
			})
			} else {
				HouseSaleTable.reload({
					where:{
						status:'空闲',
						type:2,
						structure: data.field.structure,
						area_min: data.field.area_min,
						area_max: data.field.area_max,
						price_min:data.field.price_min,
						price_max:data.field.price_max
					},
					page: {
						curr: 1 //重新从第 1 页开始
					}
				})
			}
        })
        
        //监听工具条
		table.on('tool(houseSale)', function(obj){ //注：tool是工具条事件名，test是table原始容器的属性 lay-filter="对应的值"
			var data = obj.data; //获得当前行数据
			var layEvent = obj.event; //获得 lay-event 对应的值（也可以是表头的 event 参数对应的值）
			var tr = obj.tr; //获得当前行 tr 的DOM对象
			if(layEvent === 'detail'){ //查看
				fillForm(houseSaleMsg,data);
				console.log(flag)
				if(flag === 0){
					$('input[name="rentalPrice"]').parent().parent().show();
					$('input[name="salePrice"]').parent().parent().hide();
					$('#confirmRental').show();
					$('#confirmSale').hide()
				} else if(flag === 1){
					$('input[name="salePrice"]').parent().parent().show();
					$('input[name="rentalPrice"]').parent().parent().hide();
					$('#confirmSale').show();
					$('#confirmRental').hide();
					
				}
				form.render();
				layer.open({
					type: 1,
					title:'查看房屋信息',
					skin: 'layui-layer-rim', //加上边框
  					area: ['600px', '600px'], //宽高
					content: $('#examine') //这里content是一个DOM，注意：最好该元素要存放在body最外层，否则可能被其它的相对元素所影响
				});
			}
		});

		// 房屋信息渲染轮播图
		carousel.render({
			elem: '#houseImg',
			width: '100%' ,//设置容器宽度
			height:'300px',
			arrow: 'always' //始终显示箭头
        });
        
        // 确认出租
        form.on('submit(confirmRental)',function(data){
			var resData = {
				_id: data.field._id,
				status : '已出租'
			}
			layer.confirm('确定出租该间房间吗吗？',{title:'确定出租吗？'}, function(index){
				requestData.todo('updateHouseStatus',resData,function(res){
					if(res.errcode === 0){
						layer.alert('出租房屋'+res.msg, {icon: 6},function(){
							layer.closeAll();
							location.reload();
					})
					} else {
						layer.msg(res.msg,function(){});
					}
				})
				layer.close(index);
			});
            return false;
        })
        // 确认出售
        form.on('submit(confirmSale)',function(data){
            var resData = {
				_id: data.field._id,
				status : '已出售'
			}
            layer.confirm('确定出售该间房间吗吗？',{title:'确定出售吗？'}, function(index){
				requestData.todo('updateHouseStatus',resData,function(res){
					if(res.errcode === 0){
						layer.alert('出售房屋'+res.msg, {icon: 6},function(){
							layer.closeAll();
							location.reload();
						})	
					} else {
						layer.msg(res.msg,function(){});
					}
				})
				layer.close(index);
			});
            return false;
        }) 
    });
</script>
</body>
</html>